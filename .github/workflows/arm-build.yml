name: ARM cross-build test

on:
  push:

jobs:
  unit-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/terrapkg/builder:f38
      # priv
      options: --cap-add=SYS_ADMIN --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Cache DNF packages
        uses: actions/cache@v2
        with:
          path: /var/cache/dnf
          key: dnf-${{ runner.os }}
          restore-keys: |
            dnf-${{ runner.os }}-
            dnf-

      - name: Install dependencies
        run: |
          dnf install -y \
          xorriso \
          rpm \
          limine \
          systemd \
          btrfs-progs \
          e2fsprogs \
          xfsprogs \
          dosfstools \
          grub2 \
          parted \
          util-linux-core \
          systemd-container \
          grub2-efi \
          uboot-images-armv8 \
          uboot-tools \
          rustc \
          cargo

      - uses: Swatinem/rust-cache@v2

      - name: Build and install katsu
        run: |
          cargo install --path .
      - name: Prepare loop devices
        run: |
            for i in $(seq 0 23);
            do
                sudo mknod -m 0660 /dev/loop$i b 7 0  2> /dev/null || true
            done
      - name: Run test
        run: |
          export PATH=$HOME/.cargo/bin:$PATH
          pushd tests
          katsu katsudon-arm.yaml
          popd

